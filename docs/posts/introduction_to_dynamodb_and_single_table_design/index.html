<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Introduction to DynamoDB and single table design - Andrei Roșca</title><meta name="description" content="Random Musings on Java"><meta property="og:title" content="Introduction to DynamoDB and single table design" />
<meta property="og:description" content="Introduction In this post, we&rsquo;ll try to familiarize ourselves with Amazon&rsquo;s DynamoDB database and the famous single table design. Coming from the relational world, DynamoDB looks like a strange beast at first (it&rsquo;s a NoSQL database after all) and definitely has a steep learning curve, hopefully this introduction will make things easier. We&rsquo;ll try to write a simple Spring Boot rest api which uses DynamoDB under the hood, so that we&rsquo;ll get a chance to see how everything looks in practice." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://softice.dev/posts/introduction_to_dynamodb_and_single_table_design/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-24T12:25:00+03:00" />
<meta property="article:modified_time" content="2023-04-25T22:58:12+03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Introduction to DynamoDB and single table design"/>
<meta name="twitter:description" content="Introduction In this post, we&rsquo;ll try to familiarize ourselves with Amazon&rsquo;s DynamoDB database and the famous single table design. Coming from the relational world, DynamoDB looks like a strange beast at first (it&rsquo;s a NoSQL database after all) and definitely has a steep learning curve, hopefully this introduction will make things easier. We&rsquo;ll try to write a simple Spring Boot rest api which uses DynamoDB under the hood, so that we&rsquo;ll get a chance to see how everything looks in practice."/>
<meta name="application-name" content="Andrei Roșca">
<meta name="apple-mobile-web-app-title" content="Andrei Roșca"><link rel="icon" href="https://softice.dev/images/favico.png"><link rel="apple-touch-icon" sizes="180x180" href="https://softice.dev/apple-touch-icon.png"><link rel="manifest" href="https://softice.dev/site.webmanifest"><link rel="canonical" href="https://softice.dev/posts/introduction_to_dynamodb_and_single_table_design/" /><link rel="prev" href="https://softice.dev/posts/exposing_kafka_producer_and_consumer_metrics_to_actuator/" /><link rel="stylesheet" href="https://softice.dev/css/page.min.css"><link rel="stylesheet" href="https://softice.dev/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Introduction to DynamoDB and single table design",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/softice.dev\/posts\/introduction_to_dynamodb_and_single_table_design\/"
        },"image": ["https:\/\/softice.dev\/images\/anrosca.png"],"genre": "posts","keywords": "DynamoDB, Spring Boot, Localstack","wordcount":  7123 ,
        "url": "https:\/\/softice.dev\/posts\/introduction_to_dynamodb_and_single_table_design\/","datePublished": "2023-04-24T12:25:00+03:00","dateModified": "2023-04-25T22:58:12+03:00","publisher": {
            "@type": "Organization",
            "name": "Andrei Rosca"},"author": {
                "@type": "Person",
                "name": "Andrei Rosca"
            },"description": ""
    }
    </script></head><body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="https://softice.dev/" title="Andrei Roșca"><img
        class="lazyload logo"
        src="https://softice.dev/svg/loading.min.svg"
        data-src="https://softice.dev/images/logo.png"
        data-srcset="https://softice.dev/images/logo.png, https://softice.dev/images/logo.png 1.5x, https://softice.dev/images/logo.png 2x"
        data-sizes="auto"
        alt="/images/logo.png"
        title="/images/logo.png" />Andrei Roșca&#39;s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="https://softice.dev/posts/"> Posts </a><a class="menu-item" href="https://softice.dev/tags/"> Tags </a><a class="menu-item" href="https://softice.dev/categories/"> Categories </a><a class="menu-item" href="https://softice.dev/about/"> About </a><a class="menu-item" href="https://github.com/anrosca" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="https://softice.dev/" title="Andrei Roșca"><img
        class="lazyload logo"
        src="https://softice.dev/svg/loading.min.svg"
        data-src="https://softice.dev/images/logo.png"
        data-srcset="https://softice.dev/images/logo.png, https://softice.dev/images/logo.png 1.5x, https://softice.dev/images/logo.png 2x"
        data-sizes="auto"
        alt="/images/logo.png"
        title="/images/logo.png" />Andrei Roșca&#39;s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="https://softice.dev/posts/" title="">Posts</a><a class="menu-item" href="https://softice.dev/tags/" title="">Tags</a><a class="menu-item" href="https://softice.dev/categories/" title="">Categories</a><a class="menu-item" href="https://softice.dev/about/" title="">About</a><a class="menu-item" href="https://github.com/anrosca" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="disable"><div class="single-card" ><h2 class="single-title animated flipInX">Introduction to DynamoDB and single table design</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://softice.dev/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Andrei Rosca</a></span>&nbsp;<span class="post-category">published in <a href="https://softice.dev/categories/dynamodb/"><i class="far fa-folder fa-fw"></i>DynamoDB</a>&nbsp;<a href="https://softice.dev/categories/spring-boot/"><i class="far fa-folder fa-fw"></i>Spring Boot</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-04-24">2023-04-24</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;7123 words</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;34 minutes</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#what-is-dynamodb">What is <code>DynamoDB</code>?</a>
      <ul>
        <li><a href="#dynamodb-table-anatomy"><code>DynamoDB</code> table anatomy</a></li>
        <li><a href="#read-capacity-units--write-capacity-units">Read capacity units &amp; write capacity units</a></li>
        <li><a href="#the-application-were-going-to-build">The application we&rsquo;re going to build</a></li>
      </ul>
    </li>
    <li><a href="#creating-the-project">Creating the project</a></li>
    <li><a href="#local-env-setup">Local env setup</a></li>
    <li><a href="#designing-the-dynamodb-table-around-our-access-patterns">Designing the <code>DynamoDB</code> table around our access patterns</a>
      <ul>
        <li><a href="#categories-access-patterns">Categories access patterns</a></li>
        <li><a href="#topics-access-patterns">Topics access patterns</a></li>
        <li><a href="#comments-access-patterns">Comments access patterns</a></li>
        <li><a href="#the-single-table-design">The single table design</a></li>
      </ul>
    </li>
    <li><a href="#writing-the-application">Writing the application</a></li>
    <li><a href="#creating-the-category-entity">Creating the <code>Category</code> entity</a></li>
    <li><a href="#creating-the-topic-entity">Creating the <code>Topic</code> entity</a></li>
    <li><a href="#creating-the-comment-entity">Creating the <code>Comment</code> entity</a></li>
    <li><a href="#implementing-additional-access-patterns-with-global-secondary-indexes">Implementing additional access patterns with <code>Global secondary indexes</code></a>
      <ul>
        <li><a href="#revisiting-the-single-table-design">Revisiting the <code>single table design</code></a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h2 id="introduction">Introduction</h2>
<p>In this post, we&rsquo;ll try to familiarize ourselves with Amazon&rsquo;s <code>DynamoDB</code> database and the famous single table design.
Coming from the relational world, <code>DynamoDB</code> looks like a strange beast at first (it&rsquo;s a NoSQL database after all) and
definitely has a steep learning curve, hopefully this introduction will make things easier.
We&rsquo;ll try to write a simple <code>Spring Boot</code> rest api which uses <code>DynamoDB</code> under the hood, so that we&rsquo;ll get a chance to see
how everything looks in practice.</p>
<h2 id="what-is-dynamodb">What is <code>DynamoDB</code>?</h2>
<p><code>DynamoDB</code> is a managed NoSQL, key-value database offered by <code>AWS</code>, designed to run high-performance applications at any scale.
<code>DynamoDB</code> offers an HTTP api, and it integrates seamlessly with <code>AWS lambda</code> for example.
<code>DynamoDB</code> offers consistent performance, regardless of scale. You can expect the same latency when you have 5GB of data and nothing will change when you have 1TB of data.
In <code>DynamoDB</code>, data is stored in tables, but it looks nothing like a relational database.
The biggest difference from a relational database is that <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/bp-general-nosql-design.html#bp-general-nosql-design-concepts" target="_blank" rel="noopener noreffer">AWS recommends using a single DynamoDB table for all your data</a>,
also known as the <code>single table design</code>. Yes, you&rsquo;ve read that right. When using <code>DynamoDB</code> your application/microservice will store all its data in a single table.
Sounds shocking but that&rsquo;s the most performant and cost-effective approach.
This effectively means that data modeling in <code>DynamoDB</code> is way trickier that in a relational database.</p>
<p>Data modeling in <code>DynamoDB</code> is tied to the data&rsquo;s access patterns. In order to design a <code>DynamoDB</code> table, first you need to know how that data will be fetched by an application.
The idea is that in <code>DynamoDB</code>, you can&rsquo;t write arbitrary queries which will do any projections, aggregations and filtering you like. This makes <code>DynamoDB</code> unusable for analytics, but it&rsquo;s not an issue
since <code>DynamoDB</code> was designed to be an OLTP database.</p>
<p><code>DynamoDB</code> doesn&rsquo;t support joins (like relational databases do). So there&rsquo;s no point in scattering the data around multiple tables, since you won&rsquo;t be able to join them.
Also you can forget about data normalization (because now you&rsquo;re dealing with a single table after all).
That&rsquo;s the rationale of <code>single-table-desing</code>.</p>
<h3 id="dynamodb-table-anatomy"><code>DynamoDB</code> table anatomy</h3>
<p>A <code>DynamoDB</code> table is basically a collection of items. An item is pretty much the same thing as a row in a relational database.</p>
<p>An item consists of a primary key and a bunch of attributes. Coming back to our relational database analogy, an attribute is a column. The difference is that
every item can have its own list of attributes. Not only the number of attributes for a given item can vary, also do their
types (as opposed to a relational database where every row has exactly the same number of columns.)</p>
<p>The primary key is the most interesting part of a <code>DynamoDB</code> table. A primary key uniquely identifies an item in a table, and it must be defined at the creation of the table.
There are two types of primary key: a simple primary key made up of just a partition key, and a composite primary key made up of a partition key and a sort key.</p>
<p>Designing a good <code>DynamoDB</code> table is basically picking the right partition and sort keys.</p>
<p>Let&rsquo;s look more closely at the 2 types of primary keys:</p>
<ul>
<li><code>Simple primary key</code>: as mentioned before, this is when we have a table with a partition key, but no sort key. Is this case, the only option to fetch an item is by knowing the
exact value of the partition key (well, another option is to do a table scan, where we scan the entire table item-by-item, but this is not very cost-effective).
When using just the partition key, <code>DynamoDB</code> basically looks like a plain key-value NoSQL database like redis and a good use-case for this approach is when we use <code>DynamoDB</code>
as a session store for example.</li>
<li><code>Composite primary key</code>: the primary key is composed of both a partition key and a sort key. This is where the <code>DynamoDB</code> shines.
Using this approach it&rsquo;s possible to pretty much model any OLTP use-case. The idea here is that there are more options to fetch an item. With this approach now it&rsquo;s possible to fetch an entire
collection of items. To fetch a single item we still need to know the exact values of a partition key and a sort key. The nice part is that when we want to fetch a collection of items,
we need to know the exact value of a partition key, but only a substring of the sort key. Sounds confusing but this will make sense in a bit.</li>
</ul>
<figure><img src="dynamodb-partition-key-1.gif"
         alt="DynamoDB table anatomy"/>
</figure>

<p>Also it&rsquo;s worth mentioning that good partition and sort keys should have high cardinality. <code>DynamoDB</code> looks like a hash map after all, so same principles apply here as well.</p>
<p>An odd piece of advice is that when using the <code>single-table-design</code>, good partition and sort key types are strings. These are the most versatile types our there. Though it sounds confusing, it&rsquo;ll make sense
in a bit.</p>
<p><a href="https://aws.amazon.com/blogs/database/choosing-the-right-dynamodb-partition-key/" target="_blank" rel="noopener noreffer">Look here for strategies on picking a good partition key</a>.</p>
<h3 id="read-capacity-units--write-capacity-units">Read capacity units &amp; write capacity units</h3>
<p>While creating the <code>DynamoDB</code> table, we&rsquo;ll need to configure the read &amp; write capacity units (sometimes they&rsquo;re called read request units and write request units).
That&rsquo;s basically a way to provision the maximum throughput of our database.
Here&rsquo;s what these capacity units mean:</p>
<ul>
<li>
<p>One read capacity unit gives us:</p>
<ul>
<li>A strongly consistent read request of an item up to 4 KB.</li>
<li>Two eventually consistent reads of an item up to 4 KB.</li>
</ul>
</li>
<li>
<p>One write capacity units gives us:</p>
<ul>
<li>One write per second for an item up to 1 KB in size.</li>
</ul>
</li>
</ul>
<p>Strongly and eventually consistent reads basically mean the <code>read-your-own-writes</code> semantics. For example if we write something to <code>DynamoDB</code> and instantly try to fetch the item we just wrote
can produce different results depending on the read type we use. A strongly consistent read will guarantee that we&rsquo;ll see the item we&rsquo;ve just wrote. A eventually consistent read will not (well, after a
small delay we will see the item).</p>
<p>If we do a bit of math, a table with 5 read capacity units (RCUs) can handle either 5 strongly consistent reads per second (with 4KB of data each) or for example a single strongly consistent read which fetches 20KB of data.
For eventually consistent reads, 5 RCUs give us 10 reads per second (with 4KB of data each).
Pretty much the same thing for writes. 5 Write capacity units (WCUs) give us 5 writes per second (with 1KB of data each) or a single write per second (with 5KB of data).</p>
<p>RCUs and WCUs are also intertwined with transactions, but in this post we won&rsquo;t discuss them.</p>
<p>Exceeding these limits will result in an <code>HTTP 400</code> code (Bad Request) and a <code>ProvisionedThroughputExceededException</code>.</p>
<h3 id="the-application-were-going-to-build">The application we&rsquo;re going to build</h3>
<p>Since we&rsquo;ve familiarized ourselves with a bit of theory about <code>DynamoDB</code>, let&rsquo;s try to build a simple application with it.
We&rsquo;re going to build a <code>Spring Boot</code> rest API, for a simple online forum, using <code>single-table-design</code>. To make things more clear,
here&rsquo;s an example of a entity-relationship diagram for our database:</p>
<figure><img src="relational-schema.png"
         alt="The relational schema of the app we&#39;re going to build"/>
</figure>

<p>If we were to use a relational database, every entity from the above diagram would&rsquo;ve had its own table, but since we&rsquo;re using
<code>DynamoDB</code> we&rsquo;re going to store all that data into a single table.</p>
<h2 id="creating-the-project">Creating the project</h2>
<p>Let&rsquo;s create the project skeleton. For that we&rsquo;ll go to <a href="https://start.spring.io" target="_blank" rel="noopener noreffer">https://start.spring.io</a> and we&rsquo;ll
select the following dependencies:</p>
<figure><img src="start.spring.io.png"
         alt="Creating the project skeleton on http://start.spring.io"/>
</figure>

<p>We&rsquo;ll also add the <code>AWS DynamoDB SDK</code>. For that we&rsquo;ll edit our <code>pom.xml</code> and add the following additional dependencies:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- Omitted for brevity   --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;properties&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;java.version&gt;</span>17<span class="nt">&lt;/java.version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;awssdk.version&gt;</span>2.20.2<span class="nt">&lt;/awssdk.version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/properties&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Omitted for brevity   --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>software.amazon.awssdk<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>dynamodb<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${awssdk.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;groupId&gt;</span>software.amazon.awssdk<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;artifactId&gt;</span>dynamodb-enhanced<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;version&gt;</span>${awssdk.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="c">&lt;!-- Omitted for brevity   --&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/dependencies&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/project&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="local-env-setup">Local env setup</h2>
<p>In order to get a chance to fiddle with <code>DynamoDB</code>, we need a database instance. There are many approaches we can use, like
the real thing from <code>AWS</code> (which costs a bit of money), or using <code>Localstack</code> or even embedded <code>DynamoDB</code>. In this post we&rsquo;re going to stick with <code>Localstack</code>.</p>
<p>Given that, we&rsquo;ll run <code>Localstack</code> as a docker container, let&rsquo;s take a look at our <code>docker-compose.yaml</code> file, shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.8&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">localstack</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;${LOCALSTACK_DOCKER_NAME-localstack_main}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">localstack/localstack:1.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:4566:4566&#34;</span><span class="w">            </span><span class="c"># LocalStack Gateway</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:4510-4559:4510-4559&#34;</span><span class="w">  </span><span class="c"># external services port range</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">DEBUG=${DEBUG-}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">LAMBDA_EXECUTOR=${LAMBDA_EXECUTOR-}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">DOCKER_HOST=unix:///var/run/docker.sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;${LOCALSTACK_VOLUME_DIR:-./volume}:/var/lib/localstack&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./dynamodb:/etc/localstack/init/ready.d</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We have a single docker container using the <code>localstack/localstack:1.4</code> docker image. Let&rsquo;s also note that there&rsquo;s a volume called <code>./dynamodb:/etc/localstack/init/ready.d</code>.
In the <code>./dynamodb</code> directory (located in the same folder as our <code>docker-compose.yaml</code>), we have a bunch of shell scripts which are called at initialization phase of <code>Localstack</code>,
which gives us a chance to create the resources we&rsquo;re going to use. In our case that&rsquo;ll be our <code>DynamoDB</code> table.</p>
<p>Specifically, we have a <code>create-table.sh</code> shell script which looks like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">awslocal dynamodb create-table <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --table-name forum <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --attribute-definitions <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>PK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>SK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --key-schema <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>PK,KeyType<span class="o">=</span>HASH <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>SK,KeyType<span class="o">=</span>RANGE <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --provisioned-throughput <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">ReadCapacityUnits</span><span class="o">=</span>5,WriteCapacityUnits<span class="o">=</span><span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above shell script creates a <code>DynamoDB</code> table, named <code>forum</code> with a partition key named <code>PK</code> of type string, and a sort key named <code>SK</code>, also of type string.
The table is located in the <code>eu-west-1</code> region and has 5 read and write capacity units.</p>
<p>Good stuff. Now let&rsquo;s try to run our <code>docker-compose.yaml</code> file with the following command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ docker-compose up
</span></span></code></pre></td></tr></table>
</div>
</div><p>We expect that not only <code>localstack</code> will start, but also that our single <code>DynamoDB</code> table will be created. We can check
that the table was indeed created either by looking at the <code>localstack's</code> logs, or by listing the <code>DynamoDb</code> tables using the
<code>AWS</code> cli, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb list-tables --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the table was indeed created, we should get the following output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;TableNames&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;forum&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="designing-the-dynamodb-table-around-our-access-patterns">Designing the <code>DynamoDB</code> table around our access patterns</h2>
<p>We&rsquo;ve mentioned that the recommended way to use <code>DynamoDB</code> is via the <code>single-table-design</code> and that the best way is to model
our data around our access patterns. So let&rsquo;s do that.
Since we&rsquo;re writing a simple rest api for an online forum, our access patterns will look something like this:</p>
<h3 id="categories-access-patterns">Categories access patterns</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Create a category
</span></span></span><span class="line"><span class="cl"><span class="err">POST {{host}}/api/v1/categories
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Anime&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;id&#34;: &#34;ba97318-8688-46bc-a945-87c187fc20c2&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Anime&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get all categories
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">[
</span></span></span><span class="line"><span class="cl"><span class="err">  {
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;id&#34;: &#34;ba97318-8688-46bc-a945-87c187fc20c2&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;name&#34;: &#34;Anime&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">  },
</span></span></span><span class="line"><span class="cl"><span class="err">  {
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;id&#34;: &#34;0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;name&#34;: &#34;Software development&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">  }
</span></span></span><span class="line"><span class="cl"><span class="err">]
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get category by id
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;id&#34;: &#34;0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Software development&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="topics-access-patterns">Topics access patterns</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Create topic for category
</span></span></span><span class="line"><span class="cl"><span class="err">POST {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Java 19 released&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;userName&#34;: &#34;mike&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;tags&#34;: [&#34;NSFW&#34;]
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;id&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Java 19 released&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;createdAt&#34;: &#34;2023-04-24T13:27:08.975920875Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;categoryId&#34;: &#34;51753a6-d5d0-47a2-8d73-e901367d6d37&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;userName&#34;: &#34;mike&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;tags&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;NSFW&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">  ]
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get topics of a category
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">[
</span></span></span><span class="line"><span class="cl"><span class="err">  {
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;id&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;name&#34;: &#34;Java 19 released&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;createdAt&#34;: &#34;2023-04-24T13:27:08.975920875Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;categoryId&#34;: &#34;51753a6-d5d0-47a2-8d73-e901367d6d37&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;userName&#34;: &#34;mike&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;tags&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="err">      &#34;NSFW&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">    ]
</span></span></span><span class="line"><span class="cl"><span class="err">  }
</span></span></span><span class="line"><span class="cl"><span class="err">]
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get a particular topic
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;id&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Java 19 released&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;createdAt&#34;: &#34;2023-04-24T13:27:08.975920875Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;categoryId&#34;: &#34;51753a6-d5d0-47a2-8d73-e901367d6d37&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;userName&#34;: &#34;mike&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;tags&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;NSFW&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">  ]
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Add tags for a topic
</span></span></span><span class="line"><span class="cl"><span class="err">POST {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}/tags
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">[
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;NSFW&#34;, &#34;TRIGGER_WARNING&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">]
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;id&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;name&#34;: &#34;Java 19 released&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;createdAt&#34;: &#34;2023-04-24T13:27:08.975920875Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;categoryId&#34;: &#34;51753a6-d5d0-47a2-8d73-e901367d6d37&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;userName&#34;: &#34;mike&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;tags&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;NSFW&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;TRIGGER_WARNING&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">  ]
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="comments-access-patterns">Comments access patterns</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get comments for a topic
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}/comments
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">[
</span></span></span><span class="line"><span class="cl"><span class="err">  {
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;author&#34;: &#34;2e0c8f82-88d3-20cf-2112-a0678be9c201&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;createdAt&#34;: &#34;2023-04-24T13:29:40.229672539Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;text&#34;: &#34;Yay! Finally&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;topicId&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;commentId&#34;: &#34;7c6db813-059d-4daa-a4b3-669ec640f135&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">    &#34;likeCount&#34;: 0
</span></span></span><span class="line"><span class="cl"><span class="err">  }
</span></span></span><span class="line"><span class="cl"><span class="err">]
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Create a comment for a topic
</span></span></span><span class="line"><span class="cl"><span class="err">POST {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}/comments
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;userId&#34;: &#34;2e0c8f82-88d3-20cf-2112-a0678be9c201&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;text&#34;: &#34;Yay&#34;
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;author&#34;: &#34;john&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;createdAt&#34;: &#34;2023-04-24T13:30:12.493868905Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;text&#34;: &#34;Yay&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;topicId&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;commentId&#34;: &#34;02a31913-0cc2-44f0-a90d-2d317433e4d3&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;likeCount&#34;: 0
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Like comment
</span></span></span><span class="line"><span class="cl"><span class="err">POST {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}/comments/{{commentId}}/likes
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">HTTP/1.1 200 
</span></span></span><span class="line"><span class="cl"><span class="err">Content-Type: application/json
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">{
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;author&#34;: &#34;john&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;createdAt&#34;: &#34;2023-04-24T13:30:12.493868905Z&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;text&#34;: &#34;Yay&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;topicId&#34;: &#34;9c62e3fa-7fdb-4a01-854a-a629d78f4859&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;commentId&#34;: &#34;02a31913-0cc2-44f0-a90d-2d317433e4d3&#34;,
</span></span></span><span class="line"><span class="cl"><span class="err">  &#34;likeCount&#34;: 1
</span></span></span><span class="line"><span class="cl"><span class="err">}
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="the-single-table-design">The single table design</h3>
<p>Given our access patterns, our single <code>DynamoDB</code> table can look like this:</p>
<figure><img src="single-table-design.png"
         alt="The single table design"/>
</figure>

<p>Let&rsquo;s take a closer look at our single table design and our access patterns.</p>
<h4 id="get-category-by-id">Get category by id</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get category by id
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We get the <code>sofwareCategoryId</code> as a path parameter and we can use it to make our partition and sort keys, which in this particular case are equal.
In order to actually fetch the category, we&rsquo;ll use the <code>GetItem</code> operation and
we&rsquo;ll need to prefix the partition and the sort key with the <code>Category#</code> string, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb get-item --table-name forum --key <span class="s1">&#39;{&#34;PK&#34;: {&#34;S&#34;: &#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;}, &#34;SK&#34;: {&#34;S&#34;: &#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;}}&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we&rsquo;ll get the following response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Item&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Software development&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll get to the <code>Java</code> version of this operation in a bit.</p>
<h4 id="get-all-categories">Get all categories</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This request is a bit more difficult since we don&rsquo;t have any data from which we can construct the partition and the sort key, and as we remember we need at least the exact value of the
partition key and a substring of the sort key in order to fetch anything. In this case one option would be to do a table scan, an operation which usually should be
avoided like a plague. This is because the table scan actually scans the whole table, item-by-item and since we have all the data into a single table, the amount of the data scanned would be
pretty significant.</p>
<p>That&rsquo;s one downside of <code>DynamoDB</code> is that operations like <code>findAll()</code> are difficult to implement, so it&rsquo;s worth considering if this operation is actually needed.
In our case it is. When scanning the table, we actually need to do a bit of filtering as well since we&rsquo;re interested only
in categories, so we&rsquo;ll have to look at the sort keys and check if they have the <code>Category#</code> prefix.
Here&rsquo;s how a table scan looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb scan --table-name forum --filter-expression <span class="s1">&#39;begins_with(SK, :value)&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --expression-attribute-values <span class="s1">&#39;{&#34;:value&#34;: {&#34;S&#34;: &#34;Category#&#34;}}&#39;</span>  --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll get the following response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Anime&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#91d17128-324a-42b2-b749-e6b7df091df9&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#91d17128-324a-42b2-b749-e6b7df091df9&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Software development&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;Count&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ScannedCount&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ConsumedCapacity&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll also see at the <code>Java</code> version in the next section.</p>
<h4 id="get-topics-of-a-category">Get topics of a category</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">### Get topics of a category
</span></span></span><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This is an interesting one. Effectively this is a one-to-many relationship, since a category has many topics.
The idea is that our <code>REST</code> endpoint receives only the <code>categoryId</code> and somehow using it we need to fetch all topics for that category.
Here&rsquo;s the data we&rsquo;re interested in, highlighted in red:</p>
<figure><img src="topics-of-a-category.png"
         alt="The topic items from our single-table-design table"/>
</figure>

<p>The idea here is that we can use the query operation of <code>DynamoDB</code>, and here we can specify the exact value of the partition key (<code>Category#4f0a4c06-6c11-4df2-9529-a993fec005c1</code>) and we know the
sort key prefix (<code>Topic#</code> in our case).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb query <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --table-name forum <span class="se">\ </span>  
</span></span><span class="line"><span class="cl">    --key-condition-expression <span class="s2">&#34;PK = :partition_key_value and begins_with(SK, :sort_key_prefix)&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --expression-attribute-values <span class="s1">&#39;{&#34;:partition_key_value&#34;: {&#34;S&#34;: &#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;}, &#34;:sort_key_prefix&#34;: {&#34;S&#34;: &#34;Topic#&#34;}}&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we&rsquo;ll get the following response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;createdAt&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-04-24T13:27:08.975920875Z&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Topic#0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Java 19 released&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;userName&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;mike&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;L&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;NSFW&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;TRIGGER_WARNING&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;createdAt&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-04-24T13:29:08.0Z&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Topic#ff8aacc6-fce1-fdf2-ff29-ff9f3fecffdcf&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;DynamoDB is fun&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;userName&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;john&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nt">&#34;L&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Count&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ScannedCount&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ConsumedCapacity&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;ll also see at the <code>Java</code> version in the next section.</p>
<p>That&rsquo;s pretty much the idea for all one-to-many relationships. We need to know only the exact value of the partition key and the prefix of the sort key (the <code>begins_with(SK, :sort_key_prefix)</code> function
takes care of the rest). Remember in the introduction section we&rsquo;ve mentioned that the <code>string</code> type is the most suitable for partition and sort keys? We just saw the answer to the question why is that.
Because we can embed in the partition/sort key the type of the entity we&rsquo;re dealing with as a prefix (like the <code>Category#</code> or the <code>Topic#</code> prefixes, and use this prefix to filter our the items we want
to receive).</p>
<h4 id="get-comments-of-a-topic">Get comments of a topic</h4>
<p>Getting the comments of a topic is pretty similar to getting topics of a category.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-http" data-lang="http"><span class="line"><span class="cl"><span class="err">GET {{host}}/api/v1/categories/{{sofwareCategoryId}}/topics/{{topicId}}/comments
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We&rsquo;re interested in the items highlighted in red. Notice that for a comment, the partition key has the format <code>Topic#{{topicId}}</code> and the
sort key has the <code>Comment#</code> prefix, so we&rsquo;ll do the same thing, execute the query operation with the exact value of
the partition key and the sort key prefix of <code>Comment#</code>.</p>
<figure><img src="topic-comments.png"
         alt="The topic comment items"/>
</figure>

<p>Here&rsquo;s how the query looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb query <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --table-name forum <span class="se">\ </span>  
</span></span><span class="line"><span class="cl">    --key-condition-expression <span class="s2">&#34;PK = :partition_key_value and begins_with(SK, :sort_key_prefix)&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --expression-attribute-values <span class="s1">&#39;{&#34;:partition_key_value&#34;: {&#34;S&#34;: &#34;Topic#0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;}, &#34;:sort_key_prefix&#34;: {&#34;S&#34;: &#34;Comment#&#34;}}&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>And we&rsquo;ll get the following response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;createdAt&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-04-24T13:27:08.975920875Z&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Comment#aa8aaca6-ace1-adfa-1a2a-daf3aeca0aca&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;likeCount&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;N&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Topic#0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Yay! Finally&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;userName&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;mike&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;Count&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ScannedCount&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;ConsumedCapacity&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="writing-the-application">Writing the application</h2>
<p>Now let&rsquo;s get to the business. For our rest api we&rsquo;ll need to configure a bunch of custom properties, so that the <code>AWS SDK</code>
will connect to our <code>localstack</code> docker container. Here&rsquo;s our properties:</p>
<pre tabindex="0"><code class="language-properties" data-lang="properties">#AWS properties
aws.endpoint-override=http://localhost:4566
aws.region=eu-west-1
aws.dynamo-db-table-name=forum
aws.credentials.secret-key=localstack
aws.credentials.access-key=localstack
</code></pre><p>We&rsquo;ll bind these properties to a couple of Java classes using the <code>@ConfigurationProperties</code> annotation, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="s">&#34;aws&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">record</span> <span class="nf">AwsProperties</span><span class="o">(</span><span class="n">String</span> <span class="n">endpointOverride</span><span class="o">,</span> <span class="n">String</span> <span class="n">region</span><span class="o">,</span> <span class="n">String</span> <span class="n">dynamoDbTableName</span><span class="o">,</span> <span class="n">AwsCredentials</span> <span class="n">credentials</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConstructorBinding</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AwsProperties</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">record</span> <span class="nf">AwsCredentials</span><span class="o">(</span><span class="n">String</span> <span class="n">accessKey</span><span class="o">,</span> <span class="n">String</span> <span class="n">secretKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ConstructorBinding</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AwsCredentials</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we can get to the part where we configure the <code>AWS</code> <code>DynamoDbClient</code> and <code>DynamoDbEnhancedClient</code>, which we&rsquo;ll use to
communicate with <code>DynamoDB</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">AwsProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbClient</span> <span class="nf">dynamoDbClient</span><span class="o">(</span><span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="n">AwsBasicCredentials</span> <span class="n">awsCredentials</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DynamoDbClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">region</span><span class="o">(</span><span class="n">Region</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">region</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">credentialsProvider</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">awsCredentials</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AwsBasicCredentials</span> <span class="nf">awsCredentials</span><span class="o">(</span><span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">AwsBasicCredentials</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">credentials</span><span class="o">().</span><span class="na">accessKey</span><span class="o">(),</span> <span class="n">properties</span><span class="o">.</span><span class="na">credentials</span><span class="o">().</span><span class="na">secretKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbEnhancedClient</span> <span class="nf">dynamoDbEnhancedClient</span><span class="o">(</span><span class="n">DynamoDbClient</span> <span class="n">dynamoDbClient</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DynamoDbEnhancedClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                     <span class="o">.</span><span class="na">dynamoDbClient</span><span class="o">(</span><span class="n">dynamoDbClient</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The most interesting part here probably is the usage of the <code>aws.endpoint-override</code> property, which makes our <code>DynamoDB</code> clients
actually connect to <code>localstack</code> and not to the <code>AWS</code> endpoints. If we indend to actually connect to <code>AWS</code>, the <code>aws.endpoint-override</code>
should be removed or commented out.</p>
<h2 id="creating-the-category-entity">Creating the <code>Category</code> entity</h2>
<p>As we saw in the data modelling section, we&rsquo;re using composite primary keys, so all of our items will have a partition and a sort key.
It can be helpful to create a superclass of all of our entities, which will declare the
partition and the sort keys, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbPartitionKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;PK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPartitionKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbSortKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;SK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSortKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now coming back to our <code>Category</code> entity, we just need to inherit from our <code>DynamoDbBase</code> class and add the needed properties, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DynamoDbBean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="kd">extends</span> <span class="n">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CATEGORY_PK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Category#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CATEGORY_SK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Category#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Category</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Category</span><span class="o">(</span><span class="n">CategoryBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setPartitionKey</span><span class="o">(</span><span class="n">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">setSortKey</span><span class="o">(</span><span class="n">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbIgnore</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getSortKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">CATEGORY_PK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">+</span> <span class="n">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CategoryBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CategoryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CategoryKeyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makePartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">CATEGORY_PK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makeSortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">CATEGORY_SK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CategoryBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">name</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">partitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">partitionKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">sortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">sortKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Category</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Category</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice the nested <code>CategoryKeyBuilder</code> class. It&rsquo;s a little helper class which will come in handy when we&rsquo;ll need to set the partition and the sort key, with the right prefixes.</p>
<p>We&rsquo;ll also need to adjust a bit our <code>DynamoDbConfig</code> class, so that we declare our newly-created entity there as a table, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">AwsProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Omitted for brevity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">categoryTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;re finally ready to implement our <code>DynamoDBCategoryRepository</code>, which is presented below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDBCategoryRepository</span> <span class="kd">implements</span> <span class="n">CategoryRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDBCategoryRepository</span><span class="o">(</span><span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">categoryTable</span> <span class="o">=</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Expression</span> <span class="n">expression</span> <span class="o">=</span> <span class="n">Expression</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                          <span class="o">.</span><span class="na">expression</span><span class="o">(</span><span class="s">&#34;begins_with(SK, :skPrefix)&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                          <span class="o">.</span><span class="na">expressionValues</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;:skPrefix&#34;</span><span class="o">,</span> <span class="n">AttributeValue</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">s</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CATEGORY_SK_PREFIX</span><span class="o">).</span><span class="na">build</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                                          <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">ScanEnhancedRequest</span> <span class="n">scanEnhancedRequest</span> <span class="o">=</span> <span class="n">ScanEnhancedRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                                                     <span class="o">.</span><span class="na">filterExpression</span><span class="o">(</span><span class="n">expression</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                                                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryTable</span><span class="o">.</span><span class="na">scan</span><span class="o">(</span><span class="n">scanEnhancedRequest</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">page</span> <span class="o">-&gt;</span> <span class="n">page</span><span class="o">.</span><span class="na">items</span><span class="o">().</span><span class="na">stream</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Category</span> <span class="nf">create</span><span class="o">(</span><span class="n">Category</span> <span class="n">categoryToCreate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">categoryToCreate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryToCreate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">categoryTable</span><span class="o">.</span><span class="na">getItem</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Nothing fancy here. We&rsquo;ve injected our <code>DynamoDbTable&lt;Category&gt;</code> declared in the <code>DynamoDbConfig</code> and we use it to execute the needed <code>DynamoDB</code> operations, like <code>PutItem</code> to create items,
<code>GetItem</code> to fetch a single item and the <code>Scan</code> to find all categories.</p>
<p>We won&rsquo;t show the rest of the plumbing, like injecting this repository into a service and the injecting that service into a controller. This part is pretty obvious, and all the code will be available
on GitHub.</p>
<h2 id="creating-the-topic-entity">Creating the <code>Topic</code> entity</h2>
<p>Here&rsquo;s how our <code>Topic</code> entity looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">enum</span> <span class="n">TopicTag</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">NSFW</span><span class="o">,</span> <span class="n">VIOLENCE</span><span class="o">,</span> <span class="n">GAMBLING</span><span class="o">,</span> <span class="n">TRIGGER_WARNING</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@DynamoDbBean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic</span> <span class="kd">extends</span> <span class="n">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_PK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Category#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_SK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Topic#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Topic</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Topic</span><span class="o">(</span><span class="n">TopicBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbIgnore</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getSortKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">TOPIC_SK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">TopicKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCategoryId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getPartitionKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">TOPIC_PK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//the rest of the getters &amp; setters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">TopicBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">TopicBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TopicBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">title</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">userName</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">createdAt</span><span class="o">(</span><span class="n">Instant</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">tags</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">partitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">partitionKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">sortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">sortKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">gsi1SortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">categoryId</span><span class="o">(</span><span class="n">String</span> <span class="n">categoryId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">TopicKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">categoryId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Topic</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Topic</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TopicKeyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makePartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TOPIC_PK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makeSortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TOPIC_SK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Apart from this, we&rsquo;ll need to adjust our <code>DynamoDbConfig</code> class again and register the <code>Topic</code> entity as a table, as shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">AwsProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Ommitted for brevity
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">categoryTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">topicTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It looks kind of strange, the code presented above looks like we have 2 <code>DynamoDB</code> tables, right? That&rsquo;s not true though.
We have a single table because we&rsquo;ve used the same table name for both of them and this is just a way to tell the <code>AWS</code> SDK
the schema of the entities we&rsquo;re using, so that it can do the mapping of the <code>DynamoDB</code> API responses.</p>
<p>And finally, here&rsquo;s how our <code>TopicRepository</code> looks like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbTopicRepository</span> <span class="kd">implements</span> <span class="n">TopicRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topicTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDbTopicRepository</span><span class="o">(</span><span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topicTable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">topicTable</span> <span class="o">=</span> <span class="n">topicTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">findByCategory</span><span class="o">(</span><span class="n">String</span> <span class="n">categoryId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">QueryConditional</span> <span class="n">skBeginsWithQuery</span> <span class="o">=</span> <span class="n">QueryConditional</span><span class="o">.</span><span class="na">sortBeginsWith</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">TopicKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">categoryId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">TOPIC_SK_PREFIX</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">topicTable</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">skBeginsWithQuery</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                         <span class="o">.</span><span class="na">items</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                         <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                         <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Topic</span> <span class="nf">create</span><span class="o">(</span><span class="n">Topic</span> <span class="n">topicToCreate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">topicTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">topicToCreate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">topicToCreate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">findByCategoryIdAndTopicId</span><span class="o">(</span><span class="n">String</span> <span class="n">categoryId</span><span class="o">,</span> <span class="n">String</span> <span class="n">topicId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">TopicKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">categoryId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">TopicKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">topicId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">topicTable</span><span class="o">.</span><span class="na">getItem</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">addTags</span><span class="o">(</span><span class="n">String</span> <span class="n">categoryId</span><span class="o">,</span> <span class="n">String</span> <span class="n">topicId</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tagsToAdd</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">findByCategoryIdAndTopicId</span><span class="o">(</span><span class="n">categoryId</span><span class="o">,</span> <span class="n">topicId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">topic</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">topic</span><span class="o">.</span><span class="na">setTags</span><span class="o">(</span><span class="n">mergeTopicTags</span><span class="o">(</span><span class="n">tagsToAdd</span><span class="o">,</span> <span class="n">topic</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">topic</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">                <span class="o">})</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">topicTable</span><span class="o">::</span><span class="n">updateItem</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="nf">mergeTopicTags</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tagsToAdd</span><span class="o">,</span> <span class="n">Topic</span> <span class="n">topic</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Set</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">mergedTags</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">tagsToAdd</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">mergedTags</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getTags</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">topic</span><span class="o">.</span><span class="na">getTags</span><span class="o">()</span> <span class="o">:</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mergedTags</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s not too complex either. To create topics we use the <code>PutItem</code> operation, to fetch all topics for a category we use the
<code>Query</code> operation and specify the exact value of the partition key and the sort key prefix and finally we use the <code>GetItem</code>
operation to fetch the topic by its id (in this case by specifying the exact values of partition and the sort key).</p>
<h2 id="creating-the-comment-entity">Creating the <code>Comment</code> entity</h2>
<p>The <code>Comment</code> entity looks similar to the <code>Topic</code> entity. Let&rsquo;s take a look:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DynamoDbBean</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Comment</span> <span class="kd">extends</span> <span class="n">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COMMENT_PK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Topic#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">COMMENT_SK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Comment#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">text</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">long</span> <span class="n">likeCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Comment</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="nf">Comment</span><span class="o">(</span><span class="n">CommentBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">userId</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">userId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">text</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">likeCount</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">likeCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">CommentKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">topicId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">id</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">CommentKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">id</span><span class="o">)</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbIgnore</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sortKey</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">COMMENT_SK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">CommentKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//other getters &amp; setters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CommentBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CommentBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getTopicId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">partitionKey</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">COMMENT_PK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CommentBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">text</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">topicId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="kt">long</span> <span class="n">likeCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">userName</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">createdAt</span><span class="o">(</span><span class="n">Instant</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">text</span><span class="o">(</span><span class="n">String</span> <span class="n">text</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">likeCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">likeCount</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">likeCount</span> <span class="o">=</span> <span class="n">likeCount</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">topicId</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">topicId</span> <span class="o">=</span> <span class="n">topicId</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Comment</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Comment</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CommentBuilder</span> <span class="nf">id</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CommentKeyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makePartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">COMMENT_PK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makeSortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">COMMENT_SK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Basically we have comment-specific attributes along with the helper <code>CommentKeyBuilder</code>. Apart from this, we&rsquo;ll need to
adjust one more time the <code>DynamoDbConfig</code> so that we declare the <code>Comment</code> entity, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">AwsProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//same as in previous examples
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">categoryTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">topicTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="nf">commentTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And finally, the <code>CommentRepository</code> looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbCommentRepository</span> <span class="kd">implements</span> <span class="n">CommentRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">commentTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbClient</span> <span class="n">dynamoDbClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AwsProperties</span> <span class="n">awsProperties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDbCommentRepository</span><span class="o">(</span><span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">commentTable</span><span class="o">,</span> <span class="n">DynamoDbClient</span> <span class="n">dynamoDbClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">awsProperties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">commentTable</span> <span class="o">=</span> <span class="n">commentTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">dynamoDbClient</span> <span class="o">=</span> <span class="n">dynamoDbClient</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">awsProperties</span> <span class="o">=</span> <span class="n">awsProperties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="nf">findByTopic</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">QueryConditional</span> <span class="n">skBeginsWithQuery</span> <span class="o">=</span> <span class="n">buildSkBeginsWithKeyQuery</span><span class="o">(</span><span class="n">topicId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">QueryEnhancedRequest</span> <span class="n">reverseOrderQuery</span> <span class="o">=</span> <span class="n">QueryEnhancedRequest</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">queryConditional</span><span class="o">(</span><span class="n">skBeginsWithQuery</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">scanIndexForward</span><span class="o">(</span><span class="n">Boolean</span><span class="o">.</span><span class="na">FALSE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">commentTable</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">reverseOrderQuery</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="na">items</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                           <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Comment</span> <span class="nf">create</span><span class="o">(</span><span class="n">Comment</span> <span class="n">commentToCreate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">commentTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">commentToCreate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">commentToCreate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="nf">findByTopicIdAndCommentId</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">,</span> <span class="n">String</span> <span class="n">commentId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">topicId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">commentId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">commentTable</span><span class="o">.</span><span class="na">getItem</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">,</span> <span class="n">String</span> <span class="n">commentId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">topicId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">commentId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">commentTable</span><span class="o">.</span><span class="na">getItem</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="nf">likeComment</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">,</span> <span class="n">String</span> <span class="n">commentId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">UpdateItemRequest</span> <span class="n">updateItemRequest</span> <span class="o">=</span> <span class="n">UpdateItemRequest</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">tableName</span><span class="o">(</span><span class="n">awsProperties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">key</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;PK&#34;</span><span class="o">,</span> <span class="n">AttributeValue</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">s</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">topicId</span><span class="o">)).</span><span class="na">build</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">                        <span class="s">&#34;SK&#34;</span><span class="o">,</span> <span class="n">AttributeValue</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">s</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">commentId</span><span class="o">)).</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">updateExpression</span><span class="o">(</span><span class="s">&#34;SET likeCount = likeCount + :increment_amount&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">expressionAttributeValues</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;:increment_amount&#34;</span><span class="o">,</span> <span class="n">AttributeValue</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">n</span><span class="o">(</span><span class="s">&#34;1&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">()))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">UpdateItemResponse</span> <span class="n">updateItemResponse</span> <span class="o">=</span> <span class="n">dynamoDbClient</span><span class="o">.</span><span class="na">updateItem</span><span class="o">(</span><span class="n">updateItemRequest</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">findById</span><span class="o">(</span><span class="n">topicId</span><span class="o">,</span> <span class="n">commentId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">QueryConditional</span> <span class="nf">buildSkBeginsWithKeyQuery</span><span class="o">(</span><span class="n">String</span> <span class="n">topicId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">QueryConditional</span><span class="o">.</span><span class="na">sortBeginsWith</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">CommentKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">topicId</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Comment</span><span class="o">.</span><span class="na">COMMENT_SK_PREFIX</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">               <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Probably the most interesting method here is the <code>likeComment</code>, which is used to increment by one the <code>likeCount</code> attribute.
Here we&rsquo;ve used the <code>DynamoDbClient</code> class, which is a bit more lower-lever than <code>DynamoDbTable</code>. It&rsquo;s just an example,
but it&rsquo;s worth mentioning that <code>DynamoDbClient</code> has more operations than <code>DynamoDbTable</code>, so it&rsquo;s necessary to resort to it at times.</p>
<h2 id="implementing-additional-access-patterns-with-global-secondary-indexes">Implementing additional access patterns with <code>Global secondary indexes</code></h2>
<p>So far we&rsquo;ve implemented quite a lot of access patterns. We can list all categories, get a category by its id, list the topics for a given category,
we can also get the topic by its id or even add tags to an existing topic. We can get the comments for a particular topic and we can like a comment.</p>
<p>What if we&rsquo;d like to find all the topics which were created by a particular user? Given our current database model, the only option
to achieve that is by doing a table scan, which we mentioned that it&rsquo;s a terrible idea.</p>
<p>A better option to do that is via <code>Global secondary indexes</code>. A global secondary index is an index which allows us to use
a completely different set of partition and sort keys to access our data. Also an important thing to point out is that the
global secondary index needs to be provisioned separately (meaning it has its own RCUs and WCUs). Also compared to the <code>DynamoDB</code> table,
the global secondary index allows only eventually consistent reads.</p>
<p>In order to create the global secondary index at table creation time, we&rsquo;ll need to adjust our <code>localstack</code> initialization shell-script like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">awslocal dynamodb create-table <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --table-name forum <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --attribute-definitions <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>PK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>SK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>GSI1PK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>GSI1SK,AttributeType<span class="o">=</span>S <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --key-schema <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>PK,KeyType<span class="o">=</span>HASH <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">AttributeName</span><span class="o">=</span>SK,KeyType<span class="o">=</span>RANGE <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --global-secondary-indexes <span class="s1">&#39;IndexName=forum-gsi,KeySchema=[{AttributeName=GSI1PK,KeyType=HASH},\
</span></span></span><span class="line"><span class="cl"><span class="s1">    {AttributeName=GSI1SK,KeyType=RANGE}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=10,WriteCapacityUnits=10}&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --provisioned-throughput <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        <span class="nv">ReadCapacityUnits</span><span class="o">=</span>5,WriteCapacityUnits<span class="o">=</span><span class="m">5</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above command created a global secondary index named <code>forum-gsi</code> with the partition key named <code>GSI1PK</code> and the sort key <code>GSI1SK</code>, and the provisioned throughput of 10 RCUs and 10 WCUs.</p>
<p>Now we can adjust a bit our <code>DynamoDbBase</code> superclass, so that the new set of partition and sort key is added. It will look something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">gsi1PartitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">gsi1SortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbPartitionKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;PK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPartitionKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbSortKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;SK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSortKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;GSI1PK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbSecondaryPartitionKey</span><span class="o">(</span><span class="n">indexNames</span> <span class="o">=</span> <span class="n">IndexNames</span><span class="o">.</span><span class="na">GS1_INDEX_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGsi1PartitionKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gsi1PartitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;GSI1SK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbSecondarySortKey</span><span class="o">(</span><span class="n">indexNames</span> <span class="o">=</span> <span class="n">IndexNames</span><span class="o">.</span><span class="na">GS1_INDEX_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getGsi1SortKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">gsi1SortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This effectively means that every item from our <code>DynamoDB</code> table will have 2 sets of primary keys:</p>
<ul>
<li>The <code>PK</code> partition key and a sort key named <code>SK</code></li>
<li>The <code>GSI1PK</code> partition key and a sort key named <code>GSI1SK</code>, both of which come from the global secondary index (or <code>GSI</code>).</li>
</ul>
<p>We can query items either using the main primary key (the <code>PK</code> partition key and the <code>SK</code> sort key) or the one from the <code>GSI</code> (the <code>GSI1PK</code> partition key and the <code>GSI1SK</code> sort key).</p>
<h3 id="revisiting-the-single-table-design">Revisiting the <code>single table design</code></h3>
<p>Let&rsquo;s take another look at our <code>DynamoDB</code> table, after the global secondary index was added. It will look something like this:</p>
<figure><img src="gsi1.png"
         alt="The table structure after the global secondary index"/>
</figure>

<p>Notice the values of <code>GSI1PK</code> and <code>GSI1SK</code>, which form our new primary key. So, in order to fetch all topics created by the user <code>mike</code> for example,
we&rsquo;ll need to query our global secondary index and use the <code>User#mike</code> as the partition key and the <code>Topic#</code> prefix as the sort key.</p>
<p>Here&rsquo;s how it will look like using the <code>AWS</code> CLI:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ aws dynamodb query --table-name forum --index-name forum-gsi<span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --key-condition-expression <span class="s2">&#34;GSI1PK = :partition_key_value and begins_with(GSI1SK, :sort_key_prefix)&#34;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --expression-attribute-values <span class="s1">&#39;{&#34;:partition_key_value&#34;: {&#34;S&#34;: &#34;User#mike&#34;}, &#34;:sort_key_prefix&#34;: {&#34;S&#34;: &#34;Topic#&#34;}}&#39;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    --endpoint-url http://localhost:4566 --region eu-west-1
</span></span></code></pre></td></tr></table>
</div>
</div><p>We should get the following response:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;createdAt&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;2023-04-24T13:27:08.975920875Z2023-04-24T13:27:08.975920875Z&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;GSI1PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;User#mike&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;GSI1SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Topic#0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;SK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Topic#0f8aacc6-dce1-4df2-1529-d9f3fec10dc2&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;PK&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Category#4f0a4c06-6c11-4df2-9529-a993fec005c1&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;title&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;Java 19 released&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;userName&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;mike&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;L&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nt">&#34;S&#34;</span><span class="p">:</span> <span class="s2">&#34;NSFW&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;Count&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ScannedCount&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ConsumedCapacity&#34;</span><span class="p">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Or in other words, we just fetched the data highlighted in red:</p>
<figure><img src="user-topics.png"
         alt="The user topics fetched by the gsi"/>
</figure>

<p>In order to implement this operation in Java, we&rsquo;ll need to adjust our <code>Topic</code> entity a bit, so that it sets proper values for the <code>GSI1PK</code> partition key and the <code>GSI1SK</code> sort key,
like shown here:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DynamoDbBean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic</span> <span class="kd">extends</span> <span class="n">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_PK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Category#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TOPIC_SK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Topic#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">USER_GSI1_PK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;User#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Topic</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Topic</span><span class="o">(</span><span class="n">TopicBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">gsi1SortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">gsi1SortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">gsi1PartitionKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">gsi1PartitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbIgnore</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getSortKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">TOPIC_SK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">TopicKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">gsi1SortKey</span> <span class="o">=</span> <span class="n">TopicKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCategoryId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getPartitionKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">TOPIC_PK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//the rest o the getters &amp; setters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">TopicBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">TopicBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TopicBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">Instant</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">gsi1PartitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">gsi1SortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">title</span><span class="o">(</span><span class="n">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">userName</span><span class="o">(</span><span class="n">String</span> <span class="n">userName</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">userName</span> <span class="o">=</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">gsi1PartitionKey</span> <span class="o">=</span> <span class="n">USER_GSI1_PK_PREFIX</span> <span class="o">+</span> <span class="n">userName</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">createdAt</span><span class="o">(</span><span class="n">Instant</span> <span class="n">createdAt</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">createdAt</span> <span class="o">=</span> <span class="n">createdAt</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">tags</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">TopicTag</span><span class="o">&gt;</span> <span class="n">tags</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">tags</span> <span class="o">=</span> <span class="n">tags</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">gsi1PartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">gsi1PartitionKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">gsi1PartitionKey</span> <span class="o">=</span> <span class="n">gsi1PartitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">gsi1SortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">gsi1SortKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">gsi1SortKey</span> <span class="o">=</span> <span class="n">gsi1SortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">partitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">partitionKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">sortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">sortKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">gsi1SortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">TopicBuilder</span> <span class="nf">categoryId</span><span class="o">(</span><span class="n">String</span> <span class="n">categoryId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">TopicKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">categoryId</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Topic</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Topic</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TopicKeyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makePartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TOPIC_PK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makeSortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">TOPIC_SK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And here&rsquo;s how our <code>TopicRepository</code> will look like:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbTopicRepository</span> <span class="kd">implements</span> <span class="n">TopicRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topicTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbIndex</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topicGsi1Index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDbTopicRepository</span><span class="o">(</span><span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="n">topicTable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">topicTable</span> <span class="o">=</span> <span class="n">topicTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">topicGsi1Index</span> <span class="o">=</span> <span class="n">topicTable</span><span class="o">.</span><span class="na">index</span><span class="o">(</span><span class="n">IndexNames</span><span class="o">.</span><span class="na">GS1_INDEX_NAME</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Topic</span><span class="o">&gt;</span> <span class="nf">findTopicsForUser</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">User</span><span class="o">.</span><span class="na">USER_PK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Topic</span><span class="o">.</span><span class="na">TOPIC_SK_PREFIX</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">QueryConditional</span> <span class="n">queryConditional</span> <span class="o">=</span> <span class="n">QueryConditional</span><span class="o">.</span><span class="na">sortBeginsWith</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">topicGsi1Index</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">queryConditional</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                             <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                             <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">Page</span><span class="o">::</span><span class="n">items</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                             <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">Collection</span><span class="o">::</span><span class="n">stream</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                             <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that this time we&rsquo;re querying the data from the global secondary index, not the table. That&rsquo;s pretty much the biggest difference (well, apart from the fact that the query
will always be eventually consistent).</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this blog post we&rsquo;ve made a gentle introduction to <code>DynamoDB</code>, which is a NoSQL key-value managed database, designed for OLTP workloads and
which offers consistent performance, regardless of scale.
We took a glance at the <code>AWS's</code> recommended approach to using <code>DynamoDB</code> - the single table design, and we saw that data modelling in <code>DynamoDB</code> is way trickier than in
traditional relational databases. The single table&rsquo;s data model is done after collecting the data&rsquo;s access patterns, and we saw that the global secondary indexes are a handy tool
to accommodate more access patterns.</p>
<p>It&rsquo;s also worth mentioning that a big disadvantage is that after the table was designed, it can be quite difficult to add or change new access patterns, so some careful design upfront is
definitely needed.</p>
<p>The example code we used in this article can be found on <a href="https://github.com/anrosca/dynamo-db-fiddle" target="_blank" rel="noopener noreffer">GitHub</a>.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="https://softice.dev/tags/dynamodb/">DynamoDB</a>
                </span><span><a href="https://softice.dev/tags/spring-boot/">Spring Boot</a>
                </span><span><a href="https://softice.dev/tags/localstack/">Localstack</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>Updated on 2023-04-25</span>
            </div><div class="post-info-mod"></div>
        </div></div><div class="post-nav"><a href="https://softice.dev/posts/exposing_kafka_producer_and_consumer_metrics_to_actuator/" class="prev" rel="prev" title="Exposing Kafka producer &amp; consumer metrics to actuator"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div><div id="comments" class="single-card"><div id="vssue"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/meteorlxy/vssue">Vssue</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">Andrei Roșca</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">Licensed Under CC BY-NC 4.0</a></span></div>
</div>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="https://softice.dev/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="https://softice.dev/lib/animate/animate.min.css"><link rel="stylesheet" href="https://softice.dev/lib/vue/vssue/vssue.min.css"><script src="https://softice.dev/lib/vue/vue.runtime.min.js"></script><script src="https://softice.dev/lib/vue/vssue/vssue.github.min.js"></script><script src="https://softice.dev/lib/autocomplete/autocomplete.min.js"></script><script src="https://softice.dev/lib/lunr/lunr.min.js"></script><script src="https://softice.dev/lib/lazysizes/lazysizes.min.js"></script><script src="https://softice.dev/lib/clipboard/clipboard.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":150},"comment":{"vssue":{"clientID":"886ede0c03dc0407d2e7","clientSecret":"9bb9cb2896d704ae786038c1642515c69afc6392","owner":"anrosca","repo":"softice-comments","title":"Introduction to DynamoDB and single table design"}},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="https://softice.dev/js/theme.min.js"></script></body></html>
