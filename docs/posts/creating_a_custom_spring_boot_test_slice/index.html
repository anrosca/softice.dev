<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Creating a custom Spring Boot test slice - Andrei Roșca</title><meta name="description" content="Random Musings on Java"><meta property="og:title" content="Creating a custom Spring Boot test slice" />
<meta property="og:description" content="Introduction In Spring Boot, when writing tests there&rsquo;s a way to slice up the test&rsquo;s application context, so that it contains only the beans which are appropriate for the given test. Some examples are @WebMvcTest, @DataJpaTest, @RestClientTest and many others. For example, when testing a jpa repository, we&rsquo;re not interested in the web-related components (like controllers), so using the @DataJpaTest will reduce the size of the application context, so that it contains only the repositories and other infrastructure related to that (like DataSources, EntityManagerFactory and others)." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://softice.dev/posts/creating_a_custom_spring_boot_test_slice/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-26T16:41:00+03:00" />
<meta property="article:modified_time" content="2023-03-26T21:59:19+03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creating a custom Spring Boot test slice"/>
<meta name="twitter:description" content="Introduction In Spring Boot, when writing tests there&rsquo;s a way to slice up the test&rsquo;s application context, so that it contains only the beans which are appropriate for the given test. Some examples are @WebMvcTest, @DataJpaTest, @RestClientTest and many others. For example, when testing a jpa repository, we&rsquo;re not interested in the web-related components (like controllers), so using the @DataJpaTest will reduce the size of the application context, so that it contains only the repositories and other infrastructure related to that (like DataSources, EntityManagerFactory and others)."/>
<meta name="application-name" content="Andrei Roșca">
<meta name="apple-mobile-web-app-title" content="Andrei Roșca"><link rel="icon" href="https://softice.dev/images/favico.png"><link rel="apple-touch-icon" sizes="180x180" href="https://softice.dev/apple-touch-icon.png"><link rel="manifest" href="https://softice.dev/site.webmanifest"><link rel="canonical" href="https://softice.dev/posts/creating_a_custom_spring_boot_test_slice/" /><link rel="prev" href="https://softice.dev/posts/bootiful_error_handling_with_controller_advices/" /><link rel="stylesheet" href="https://softice.dev/css/page.min.css"><link rel="stylesheet" href="https://softice.dev/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Creating a custom Spring Boot test slice",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/softice.dev\/posts\/creating_a_custom_spring_boot_test_slice\/"
        },"image": ["https:\/\/softice.dev\/images\/anrosca.png"],"genre": "posts","keywords": "Spring Boot, Testing, Localstack, DynamoDB","wordcount":  2168 ,
        "url": "https:\/\/softice.dev\/posts\/creating_a_custom_spring_boot_test_slice\/","datePublished": "2023-03-26T16:41:00+03:00","dateModified": "2023-03-26T21:59:19+03:00","publisher": {
            "@type": "Organization",
            "name": "Andrei Rosca"},"author": {
                "@type": "Person",
                "name": "Andrei Rosca"
            },"description": ""
    }
    </script></head><body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="https://softice.dev/" title="Andrei Roșca"><img
        class="lazyload logo"
        src="https://softice.dev/svg/loading.min.svg"
        data-src="https://softice.dev/images/logo.png"
        data-srcset="https://softice.dev/images/logo.png, https://softice.dev/images/logo.png 1.5x, https://softice.dev/images/logo.png 2x"
        data-sizes="auto"
        alt="/images/logo.png"
        title="/images/logo.png" />Andrei Roșca&#39;s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="https://softice.dev/posts/"> Posts </a><a class="menu-item" href="https://softice.dev/tags/"> Tags </a><a class="menu-item" href="https://softice.dev/categories/"> Categories </a><a class="menu-item" href="https://softice.dev/about/"> About </a><a class="menu-item" href="https://github.com/anrosca" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="https://softice.dev/" title="Andrei Roșca"><img
        class="lazyload logo"
        src="https://softice.dev/svg/loading.min.svg"
        data-src="https://softice.dev/images/logo.png"
        data-srcset="https://softice.dev/images/logo.png, https://softice.dev/images/logo.png 1.5x, https://softice.dev/images/logo.png 2x"
        data-sizes="auto"
        alt="/images/logo.png"
        title="/images/logo.png" />Andrei Roșca&#39;s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="https://softice.dev/posts/" title="">Posts</a><a class="menu-item" href="https://softice.dev/tags/" title="">Tags</a><a class="menu-item" href="https://softice.dev/categories/" title="">Categories</a><a class="menu-item" href="https://softice.dev/about/" title="">About</a><a class="menu-item" href="https://github.com/anrosca" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><div class="menu-item"><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="disable"><div class="single-card" ><h2 class="single-title animated flipInX">Creating a custom Spring Boot test slice</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="https://softice.dev/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Andrei Rosca</a></span>&nbsp;<span class="post-category">published in <a href="https://softice.dev/categories/spring-boot/"><i class="far fa-folder fa-fw"></i>Spring Boot</a>&nbsp;<a href="https://softice.dev/categories/dynamodb/"><i class="far fa-folder fa-fw"></i>DynamoDB</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-03-26">2023-03-26</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;2168 words</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;11 minutes</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>Contents</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#when-custom-test-sliced-are-needed">When custom test-sliced are needed</a></li>
        <li><a href="#testing-time">Testing time</a></li>
      </ul>
    </li>
    <li><a href="#creating-a-custom-test-slice">Creating a custom test-slice</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h2 id="introduction">Introduction</h2>
<p>In <code>Spring Boot</code>, when writing tests there&rsquo;s a way to slice up the test&rsquo;s application context, so that it contains only the beans which are appropriate
for the given test. Some examples are <code>@WebMvcTest</code>, <code>@DataJpaTest</code>, <code>@RestClientTest</code> and many others. For example, when testing
a jpa repository, we&rsquo;re not interested in the web-related components (like controllers), so using the <code>@DataJpaTest</code> will reduce the size
of the application context, so that it contains only the repositories and other infrastructure related to that (like <code>DataSource</code>s, <code>EntityManagerFactory</code> and others).</p>
<h3 id="when-custom-test-sliced-are-needed">When custom test-sliced are needed</h3>
<p>Let&rsquo;s say we are working on an application which uses <code>DynamoDB</code>. It is a simple <code>REST API</code> for a simple anonymous forum, having categories, topics and comments.
Let&rsquo;s have a look more closely at the categories part of the application. The <code>Category</code> entity will look something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Data</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbPartitionKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;PK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPartitionKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbSortKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamoDbAttribute</span><span class="o">(</span><span class="s">&#34;SK&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSortKey</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>DynamoDbBase</code> will act as the base-class for all entities. It has a generic partition and sort key, because we plan to use a single <code>DynamoDB</code> table for
all entities (also known as <code>Single table design</code>).</p>
<p>Now the <code>Category</code> entity finally looks like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DynamoDbBean</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Category</span> <span class="kd">extends</span> <span class="n">DynamoDbBase</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CATEGORY_PK</span> <span class="o">=</span> <span class="s">&#34;Category&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CATEGORY_SK_PREFIX</span> <span class="o">=</span> <span class="s">&#34;Category#&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Category</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Category</span><span class="o">(</span><span class="n">CategoryBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">setPartitionKey</span><span class="o">(</span><span class="n">CATEGORY_PK</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">setSortKey</span><span class="o">(</span><span class="n">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">getSortKey</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">CATEGORY_SK_PREFIX</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">CategoryBuilder</span> <span class="nf">builder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">CategoryBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CategoryKeyBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makePartitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">CATEGORY_PK</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">makeSortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">CATEGORY_SK_PREFIX</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CategoryBuilder</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">private</span> <span class="n">String</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">name</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">partitionKey</span><span class="o">(</span><span class="n">String</span> <span class="n">partitionKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">partitionKey</span> <span class="o">=</span> <span class="n">partitionKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">CategoryBuilder</span> <span class="nf">sortKey</span><span class="o">(</span><span class="n">String</span> <span class="n">sortKey</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="o">.</span><span class="na">sortKey</span> <span class="o">=</span> <span class="n">sortKey</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">Category</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="n">Category</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>It is quite simple, it just has a <code>name</code> attribute, getters &amp; setters and a builder.</p>
<p>Also we&rsquo;ll need to add a bit of configuration, by providing the <code>DynamoDbEnhancedClient</code> and <code>DynamoDbTable</code> beans, like shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Configuration</span><span class="o">(</span><span class="n">proxyBeanMethods</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableConfigurationProperties</span><span class="o">(</span><span class="n">AwsProperties</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbConfig</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbClient</span> <span class="nf">dynamoDbClient</span><span class="o">(</span><span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="n">AwsBasicCredentials</span> <span class="n">awsCredentials</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DynamoDbClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                    <span class="o">.</span><span class="na">region</span><span class="o">(</span><span class="n">Region</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">region</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">builder</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">(</span><span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">endpointOverride</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">credentialsProvider</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">awsCredentials</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AwsBasicCredentials</span> <span class="nf">awsCredentials</span><span class="o">(</span><span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">AwsBasicCredentials</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">credentials</span><span class="o">().</span><span class="na">accessKey</span><span class="o">(),</span> <span class="n">properties</span><span class="o">.</span><span class="na">credentials</span><span class="o">().</span><span class="na">secretKey</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbEnhancedClient</span> <span class="nf">dynamoDbEnhancedClient</span><span class="o">(</span><span class="n">DynamoDbClient</span> <span class="n">dynamoDbClient</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DynamoDbEnhancedClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                     <span class="o">.</span><span class="na">dynamoDbClient</span><span class="o">(</span><span class="n">dynamoDbClient</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">categoryTable</span><span class="o">(</span><span class="n">DynamoDbEnhancedClient</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">,</span> <span class="n">AwsProperties</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">dynamoDbEnhancedClient</span><span class="o">.</span><span class="na">table</span><span class="o">(</span><span class="n">properties</span><span class="o">.</span><span class="na">dynamoDbTableName</span><span class="o">(),</span> <span class="n">TableSchema</span><span class="o">.</span><span class="na">fromBean</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s try to write a repository for the <code>Category</code> entity:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CategoryRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Category</span> <span class="nf">create</span><span class="o">(</span><span class="n">Category</span> <span class="n">categoryToCreate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>CategoryRepository</code> interface specifies the repository contract, at the moment having the <code>findAll()</code>, <code>findById()</code> and <code>create()</code> operations. The implementation
can look something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Repository</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDBCategoryRepository</span> <span class="kd">implements</span> <span class="n">CategoryRepository</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDBCategoryRepository</span><span class="o">(</span><span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">categoryTable</span> <span class="o">=</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CATEGORY_PK</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CATEGORY_SK_PREFIX</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryTable</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">QueryConditional</span><span class="o">.</span><span class="na">sortBeginsWith</span><span class="o">(</span><span class="n">key</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">page</span> <span class="o">-&gt;</span> <span class="n">page</span><span class="o">.</span><span class="na">items</span><span class="o">().</span><span class="na">stream</span><span class="o">())</span>
</span></span><span class="line"><span class="cl">                            <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Category</span> <span class="nf">create</span><span class="o">(</span><span class="n">Category</span> <span class="n">categoryToCreate</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">categoryToCreate</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">categoryToCreate</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Key</span> <span class="n">key</span> <span class="o">=</span> <span class="n">Key</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">partitionValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makePartitionKey</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">sortValue</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">CategoryKeyBuilder</span><span class="o">.</span><span class="na">makeSortKey</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                     <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">categoryTable</span><span class="o">.</span><span class="na">getItem</span><span class="o">(</span><span class="n">key</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="testing-time">Testing time</h3>
<p>Now let&rsquo;s try to write a test for it. We&rsquo;ll end up with something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@SpringBootTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDBCategoryRepositoryTest</span> <span class="kd">extends</span> <span class="n">AbstractDatabaseTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DynamoDBCategoryRepository</span> <span class="n">categoryRepository</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">deleteTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">createTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Software development&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Anime&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#601735c3-6da7-4684-62d3-47af5d5dc44e&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldBeAbleToFindAllCategories</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">expectedCategories</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Software development&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">build</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Anime&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#601735c3-6da7-4684-62d3-47af5d5dc44e&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">actualCategories</span> <span class="o">=</span> <span class="n">categoryRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">assertThat</span><span class="o">(</span><span class="n">actualCategories</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedCategories</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldBeAbleToFindCategoriesById</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Category</span> <span class="n">expectedCategory</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Software development&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">actualCategory</span> <span class="o">=</span> <span class="n">categoryRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="s">&#34;501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">assertThat</span><span class="o">(</span><span class="n">actualCategory</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">expectedCategory</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>DynamoDBCategoryRepositoryTest</code> is quite simple. What&rsquo;s worth noting is that before each test we try to clean up the table, by deleting the table and
re-creating it. We also insert some test data so that we have something to work with. Also it&rsquo;s worth pointing out that this test uses <code>Localstack</code> to
simulate the real <code>DynamoDB</code> service. We spin-up <code>Localstack</code> using <code>Testcontainers</code>, and the <code>AbstractDatabaseTest</code> contains all the guts related to that:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractDatabaseTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">&#34;forum&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">LocalStackContainer</span> <span class="n">localstack</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="k">new</span> <span class="n">LocalStackContainer</span><span class="o">(</span><span class="n">DockerImageName</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&#34;localstack/localstack:1.4&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">withServices</span><span class="o">(</span><span class="n">LocalStackContainer</span><span class="o">.</span><span class="na">Service</span><span class="o">.</span><span class="na">DYNAMODB</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@DynamicPropertySource</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">replaceProperties</span><span class="o">(</span><span class="n">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;aws.endpoint-override&#34;</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">localstack</span><span class="o">.</span><span class="na">getEndpointOverride</span><span class="o">(</span><span class="n">LocalStackContainer</span><span class="o">.</span><span class="na">Service</span><span class="o">.</span><span class="na">DYNAMODB</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;aws.credentials.secret-key&#34;</span><span class="o">,</span> <span class="n">localstack</span><span class="o">::</span><span class="n">getSecretKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;aws.credentials.access-key&#34;</span><span class="o">,</span> <span class="n">localstack</span><span class="o">::</span><span class="n">getAccessKey</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;aws.region&#34;</span><span class="o">,</span> <span class="n">localstack</span><span class="o">::</span><span class="n">getRegion</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">static</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">localstack</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">createResources</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">createResources</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">localstack</span><span class="o">.</span><span class="na">execInContainer</span><span class="o">(</span><span class="s">&#34;awslocal&#34;</span><span class="o">,</span> <span class="s">&#34;dynamodb&#34;</span><span class="o">,</span> <span class="s">&#34;create-table&#34;</span><span class="o">,</span> <span class="s">&#34;--table-name&#34;</span><span class="o">,</span> <span class="n">TABLE_NAME</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;--attribute-definitions&#34;</span><span class="o">,</span> <span class="s">&#34;AttributeName=PK,AttributeType=S&#34;</span><span class="o">,</span> <span class="s">&#34;AttributeName=SK,AttributeType=S&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;--key-schema&#34;</span><span class="o">,</span> <span class="s">&#34;AttributeName=PK,KeyType=HASH&#34;</span><span class="o">,</span> <span class="s">&#34;AttributeName=SK,KeyType=RANGE&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;--provisioned-throughput&#34;</span><span class="o">,</span> <span class="s">&#34;ReadCapacityUnits=5,WriteCapacityUnits=5&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A slight problem with this test is that it uses the <code>@SpringBootTest</code> which pretty much spins up the whole application context, containing not only
repository-specific classes, but also web related ones for example. This can increase the test&rsquo;s startup time and it&rsquo;s a shame, since we don&rsquo;t care about the
web layer for this particular test. Let&rsquo;s try to fix this, by writing a custom test slice.</p>
<h2 id="creating-a-custom-test-slice">Creating a custom test-slice</h2>
<p>It&rsquo;ll be nice to create a custom test-slice. We want something like <code>@DataJpaTest</code>, which allows us to either spin up only the repository layer.
Let&rsquo;s take a look at the <code>@DataJpaTest</code> annotation, so that we find some inspiration:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">({</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Documented</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Inherited</span>
</span></span><span class="line"><span class="cl"><span class="nd">@BootstrapWith</span><span class="o">(</span><span class="n">DataJdbcTestContextBootstrapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">({</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@OverrideAutoConfiguration</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">enabled</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@TypeExcludeFilters</span><span class="o">({</span><span class="n">DataJdbcTypeExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Transactional</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AutoConfigureCache</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AutoConfigureDataJdbc</span>
</span></span><span class="line"><span class="cl"><span class="nd">@AutoConfigureTestDatabase</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ImportAutoConfiguration</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DataJdbcTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The most interesting parts are the following:</p>
<ul>
<li><code>@OverrideAutoConfiguration(enabled = false)</code>: disables auto-configuration</li>
<li><code>@BootstrapWith(DataJdbcTestContextBootstrapper.class)</code>: specifies how to bootstrap the application context. <code>DataJdbcTestContextBootstrapper</code>
is a small specialization of <code>SpringBootTestContextBootstrapper</code></li>
<li><code>@ImportAutoConfiguration</code>: allows to import some auto-configurations. It&rsquo;s useful since all auto-configurations were disabled by <code>@OverrideAutoConfiguration(enabled = false)</code></li>
<li><code>@TypeExcludeFilters({DataJdbcTypeExcludeFilter.class})</code>: this is the most interesting one, this is the actual filter of the beans which we want to include/exclude
from the application context</li>
</ul>
<p>Everything else just configures the repository infrastructure, like enabling caching (via <code>@AutoConfigureCache</code>) and transactions (via <code>@Transactional</code>).</p>
<p>Now let&rsquo;s try to create a similar thing for <code>DynamoDB</code>. We&rsquo;ll create a custom annotation named <code>@DynamoDbTest</code>, which initially will look like the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@OverrideAutoConfiguration</span><span class="o">(</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@BootstrapWith</span><span class="o">(</span><span class="n">SpringBootTestContextBootstrapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DynamoDbTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">repositories</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Since we didn&rsquo;t add yet the <code>@TypeExcludeFilters</code> annotation, with a custom implementation of the <code>TypeExcludeFilter</code>, we&rsquo;ll still end up with the whole application context.</p>
<p>But let&rsquo;s try to annotate our <code>DynamoDBCategoryRepositoryTest</code> with the <code>@DynamoDbTest</code> annotation, just to make sure everything still works:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@DynamoDbTest</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDBCategoryRepositoryTest</span> <span class="kd">extends</span> <span class="n">AbstractDatabaseTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DynamoDbTable</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">categoryTable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Autowired</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">DynamoDBCategoryRepository</span> <span class="n">categoryRepository</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@BeforeEach</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">deleteTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">createTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Software development&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">categoryTable</span><span class="o">.</span><span class="na">putItem</span><span class="o">(</span><span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Anime&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#601735c3-6da7-4684-62d3-47af5d5dc44e&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldBeAbleToFindAllCategories</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">expectedCategories</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Software development&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#501735c3-5da7-4684-82d3-37af5d5dc44f&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">build</span><span class="o">(),</span>
</span></span><span class="line"><span class="cl">            <span class="n">Category</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&#34;Anime&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">partitionKey</span><span class="o">(</span><span class="s">&#34;Category&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">sortKey</span><span class="o">(</span><span class="s">&#34;Category#601735c3-6da7-4684-62d3-47af5d5dc44e&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">build</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">List</span><span class="o">&lt;</span><span class="n">Category</span><span class="o">&gt;</span> <span class="n">actualCategories</span> <span class="o">=</span> <span class="n">categoryRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">assertThat</span><span class="o">(</span><span class="n">actualCategories</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">expectedCategories</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we try to run the tests, they pass, which means that we didn&rsquo;t broke anything yet.</p>
<figure><img src="tests-pass.png"
         alt="Tests are still passing"/>
</figure>

<p>If we try to inject the <code>ApplicationContext</code> into our <code>DynamoDBCategoryRepositoryTest</code> and inspect it in the debugger, we&rsquo;ll see something like this:</p>
<figure><img src="all-beans.png"
         alt="All beans"/>
</figure>

<p>We can observe that our <code>ApplicationContext</code> contains all the beans, including the ones from the web-layer which we&rsquo;re not interested in for this particular test.</p>
<p>In order to fix that, we&rsquo;ll implement a custom <code>TypeExcludeFilter</code>. It will look something like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbTypeExcludeFilter</span> <span class="kd">extends</span> <span class="n">AnnotationCustomizableTypeExcludeFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">DEFAULT_INCLUDES</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Repository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DynamoDbTest</span> <span class="n">annotation</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">DynamoDbTypeExcludeFilter</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">testClass</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">annotation</span> <span class="o">=</span> <span class="n">AnnotatedElementUtils</span><span class="o">.</span><span class="na">getMergedAnnotation</span><span class="o">(</span><span class="n">testClass</span><span class="o">,</span> <span class="n">DynamoDbTest</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">hasAnnotation</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">annotation</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">ComponentScan</span><span class="o">.</span><span class="na">Filter</span><span class="o">[]</span> <span class="nf">getFilters</span><span class="o">(</span><span class="n">FilterType</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">ComponentScan</span><span class="o">.</span><span class="na">Filter</span><span class="o">[</span><span class="n">0</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isUseDefaultFilters</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getDefaultIncludes</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">repositories</span><span class="o">())</span> <span class="o">?</span> <span class="n">DEFAULT_INCLUDES</span> <span class="o">:</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getComponentIncludes</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">repositories</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This custom <code>TypeExcludeFilter</code> is tied to our <code>@DynamoDbTest</code> annotation.</p>
<p>The most important part is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">DEFAULT_INCLUDES</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Repository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Which means that by-default we&rsquo;ll include in the <code>ApplicationContext</code> only beans annotated with the <code>@Repository</code> annotation. If we take another look at our
<code>@DynamoDbTest</code> annotation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DynamoDbTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">repositories</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>we can observe that we have a <code>repositories()</code> attribute, which allows us to spin up for the test either all repositories (in case the <code>repositories()</code> is empty)
or a particular one, by specifying it like this: <code>@DynamoDbTest(repositories = DynamoDBCategoryRepository.class)</code>.</p>
<p>If we&rsquo;ll leave the <code>repositories()</code> attribute empty (like the following <code>@DynamoDbTest(repositories = {})</code>, then all <code>@Repository</code>-annotated classes will end up
in the application context. <code>DynamoDbTypeExcludeFilter.getDefaultIncludes()</code> method defines this behavior:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbTypeExcludeFilter</span> <span class="kd">extends</span> <span class="n">AnnotationCustomizableTypeExcludeFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">DEFAULT_INCLUDES</span> <span class="o">=</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Repository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getDefaultIncludes</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ObjectUtils</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">repositories</span><span class="o">())</span> <span class="o">?</span> <span class="n">DEFAULT_INCLUDES</span> <span class="o">:</span> <span class="n">Set</span><span class="o">.</span><span class="na">of</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In case we do specify the desired repository, like this: <code>@DynamoDbTest(repositories = DynamoDBCategoryRepository.class)</code>, then
<code>DynamoDbTypeExcludeFilter.getComponentIncludes()</code> method specifies that only the <code>DynamoDBCategoryRepository</code> class should be included.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DynamoDbTypeExcludeFilter</span> <span class="kd">extends</span> <span class="n">AnnotationCustomizableTypeExcludeFilter</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">getComponentIncludes</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">annotation</span><span class="o">.</span><span class="na">repositories</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now we&rsquo;ll need to register the new <code>TypeExcludeFilter</code> like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@OverrideAutoConfiguration</span><span class="o">(</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@BootstrapWith</span><span class="o">(</span><span class="n">SpringBootTestContextBootstrapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@TypeExcludeFilters</span><span class="o">(</span><span class="n">DynamoDbTypeExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//&lt;--- this one was added
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DynamoDbTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">repositories</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we&rsquo;ll try to run our test now, it&rsquo;ll fail with the following error:</p>
<figure><img src="error.png"
         alt="The test fails"/>
</figure>

<p>The problem is that the <code>DynamoDbTypeExcludeFilter</code> included in the app context only the <code>@Repository</code>-annotated classes and filtered out everything else,
including our <code>DynamoDbConfig</code> java-config class, which declares our <code>DynamoDB</code> table.</p>
<p>In order to fix that, we&rsquo;ll need to register the <code>DynamoDbConfig</code> in the <code>@DynamoDbTest</code> annotation, like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@ExtendWith</span><span class="o">(</span><span class="n">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@OverrideAutoConfiguration</span><span class="o">(</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ImportAutoConfiguration</span><span class="o">(</span><span class="n">dev</span><span class="o">.</span><span class="na">softice</span><span class="o">.</span><span class="na">slice</span><span class="o">.</span><span class="na">config</span><span class="o">.</span><span class="na">DynamoDbConfig</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">//&lt;--- this one was added
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nd">@BootstrapWith</span><span class="o">(</span><span class="n">SpringBootTestContextBootstrapper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@TypeExcludeFilters</span><span class="o">(</span><span class="n">DynamoDbTypeExcludeFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">DynamoDbTest</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">repositories</span><span class="o">()</span> <span class="k">default</span> <span class="o">{};</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, not only our test will pass, but it&rsquo;s <code>ApplicationContext</code> will contain only <code>DynamoDB</code>-specific beans, like shown below:</p>
<figure><img src="finally-tests-pass.png"
         alt="The test passes"/>
</figure>

<h2 id="conclusion">Conclusion</h2>
<p>In this blog post we saw how to create a custom <code>Spring Boot</code> test slice for <code>DynamoDB</code>. We saw that it&rsquo;s pretty easy, we just need a custom annotation annotated
with:</p>
<ul>
<li><code>@OverrideAutoConfiguration(enabled = false)</code>: disables auto-configuration</li>
<li><code>@ImportAutoConfiguration(dev.softice.slice.config.DynamoDbConfig.class)</code>: import a specific auto-configuration class</li>
<li><code>@BootstrapWith(SpringBootTestContextBootstrapper.class)</code>: specifies the application-context bootstrapper</li>
<li><code>@TypeExcludeFilters(DynamoDbTypeExcludeFilter.class)</code>: registers a <code>TypeExcludeFilter</code> which filters out beans we&rsquo;re not interested in</li>
</ul>
<p>The example code we used in this article can be found on <a href="https://github.com/anrosca/custom-spring-boot-test-slice/" target="_blank" rel="noopener noreffer">GitHub</a>.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="https://softice.dev/tags/spring-boot/">Spring Boot</a>
                </span><span><a href="https://softice.dev/tags/testing/">Testing</a>
                </span><span><a href="https://softice.dev/tags/localstack/">Localstack</a>
                </span><span><a href="https://softice.dev/tags/dynamodb/">DynamoDB</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>Updated on 2023-03-26</span>
            </div><div class="post-info-mod"></div>
        </div></div><div class="post-nav"><a href="https://softice.dev/posts/bootiful_error_handling_with_controller_advices/" class="prev" rel="prev" title="Bootiful error handling with @ControllerAdvices"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a></div></div>
</div><div id="comments" class="single-card"><div id="vssue"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://github.com/meteorlxy/vssue">Vssue</a>.
            </noscript></div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">Andrei Roșca</div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">Licensed Under CC BY-NC 4.0</a></span></div>
</div>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment-alt fa-fw"></i>
            </a></div><link rel="stylesheet" href="https://softice.dev/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="https://softice.dev/lib/animate/animate.min.css"><link rel="stylesheet" href="https://softice.dev/lib/vue/vssue/vssue.min.css"><script src="https://softice.dev/lib/vue/vue.runtime.min.js"></script><script src="https://softice.dev/lib/vue/vssue/vssue.github.min.js"></script><script src="https://softice.dev/lib/autocomplete/autocomplete.min.js"></script><script src="https://softice.dev/lib/lunr/lunr.min.js"></script><script src="https://softice.dev/lib/lazysizes/lazysizes.min.js"></script><script src="https://softice.dev/lib/clipboard/clipboard.min.js"></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":150},"comment":{"vssue":{"clientID":"886ede0c03dc0407d2e7","clientSecret":"9bb9cb2896d704ae786038c1642515c69afc6392","owner":"anrosca","repo":"softice-comments","title":"Creating a custom Spring Boot test slice"}},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script src="https://softice.dev/js/theme.min.js"></script></body></html>
